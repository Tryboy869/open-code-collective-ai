<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open-Code Collective AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f3f4f6;
            --white: #ffffff;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--white);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
        }

        header h1 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 10px;
        }

        header p {
            color: var(--gray);
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--light);
        }

        .credits {
            background: var(--primary);
            color: var(--white);
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 18px;
        }

        /* Sections */
        .section {
            background: var(--white);
            padding: 30px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section h2 {
            color: var(--dark);
            margin-bottom: 20px;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* Forms */
        input[type="text"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: border 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 500;
        }

        /* Repo List */
        .repo-list {
            display: grid;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .repo-item {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .repo-item:hover {
            background: #e5e7eb;
            transform: translateX(5px);
        }

        .repo-info {
            flex: 1;
        }

        .repo-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .repo-meta {
            font-size: 14px;
            color: var(--gray);
        }

        .repo-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge-success {
            background: #d1fae5;
            color: var(--success);
        }

        .badge-warning {
            background: #fef3c7;
            color: var(--warning);
        }

        .badge-danger {
            background: #fee2e2;
            color: var(--danger);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
            border-radius: 8px;
            color: var(--white);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid var(--light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d1fae5;
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .alert-error {
            background: #fee2e2;
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .alert-info {
            background: #dbeafe;
            color: #3b82f6;
            border-left: 4px solid #3b82f6;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light);
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-card {
            background: var(--white);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 100%;
        }

        .login-card h1 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 30px;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-screen">
    <div class="login-card">
        <h1>üåå Open-Code Collective AI</h1>
        <p style="text-align: center; color: var(--gray); margin-bottom: 30px;">
            Contribuez votre code. Alimentez l'IA. Cr√©ez l'impossible.
        </p>

        <div id="loginAlert" class="alert"></div>

        <label>Username GitHub/GitLab</label>
        <input type="text" id="gitUsername" placeholder="votre-username" />

        <label>Personal Access Token</label>
        <input type="password" id="gitToken" placeholder="ghp_..." />

        <p style="font-size: 14px; color: var(--danger); margin-bottom: 20px; font-weight: 600;">
            ‚ö†Ô∏è ATTENTION S√âCURIT√â : Ce token est stock√© ENCOD√â (non chiffr√©) localement dans votre navigateur. Utilisez un token avec des permissions limit√©es.
        </p>

        <button class="btn" onclick="login()" style="width: 100%;">
            Connexion
        </button>

        <p style="text-align: center; margin-top: 20px; font-size: 14px; color: var(--gray);">
            Pas de token ? 
            <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--primary);">
                Cr√©er un token GitHub
            </a>
        </p>
    </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" class="hidden">
    <div class="container">
        <header>
            <h1>üåå Open-Code Collective AI</h1>
            <p>Le plus grand dataset open-source de code jamais cr√©√©</p>

            <div class="user-info">
                <div>
                    <strong id="usernameDisplay">User</strong>
                    <button class="btn btn-danger btn-small" onclick="logout()" style="margin-left: 15px;">
                        D√©connexion
                    </button>
                </div>
                <div class="credits">
                    üíé <span id="creditsDisplay">0</span> cr√©dits
                </div>
            </div>
        </header>

        <!-- Tabs -->
        <div class="tabs">
            <!-- IMPORTANT FIX: switchTab now requires passing 'this' element for clean targeting -->
            <button class="tab active" onclick="switchTab(this, 'repos')">üì¶ Mes Repos</button>
            <button class="tab" onclick="switchTab(this, 'generate')">ü§ñ G√©n√©rer du Code</button>
            <button class="tab" onclick="switchTab(this, 'config')">‚öôÔ∏è Configuration IA</button>
            <button class="tab" onclick="switchTab(this, 'stats')">üìä Statistiques</button>
        </div>

        <!-- TAB: Repos -->
        <div id="tab-repos" class="tab-content active">
            <div class="section">
                <h2>üì¶ Vos D√©p√¥ts GitHub</h2>

                <div id="repoAlert" class="alert"></div>

                <button class="btn" onclick="loadRepos()">
                    üîÑ Charger mes repos
                </button>

                <div id="repoLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Chargement de vos repos...</p>
                </div>

                <div id="repoList" class="repo-list" style="margin-top: 20px;">
                    <!-- Repos will be loaded here -->
                </div>

                <button class="btn btn-success" onclick="contributeSelected()" style="margin-top: 20px;">
                    ‚úÖ Contribuer les repos s√©lectionn√©s
                </button>
            </div>
        </div>

        <!-- TAB: Generate -->
        <div id="tab-generate" class="tab-content">
            <div class="section">
                <h2>ü§ñ G√©n√©rer du Code</h2>

                <div id="generateAlert" class="alert"></div>

                <label>D√©crivez ce que vous voulez cr√©er</label>
                <textarea id="prompt" rows="5" placeholder="Ex: Cr√©er un composant React pour un formulaire de login avec validation..."></textarea>

                <label>Langage de programmation</label>
                <select id="language">
                    <option value="javascript">JavaScript</option>
                    <option value="typescript">TypeScript</option>
                    <option value="python">Python</option>
                    <option value="go">Go</option>
                    <option value="rust">Rust</option>
                    <option value="java">Java</option>
                    <option value="php">PHP</option>
                    <option value="ruby">Ruby</option>
                    <option value="c">C</option>
                    <option value="cpp">C++</option>
                </select>

                <label>Complexit√© estim√©e</label>
                <select id="complexity" onchange="updateGenerateButtonCost()">
                    <option value="snippet" data-cost="1">Snippet (1 cr√©dit)</option>
                    <option value="script" data-cost="2">Script (2 cr√©dits)</option>
                    <option value="component" data-cost="5">Composant (5 cr√©dits)</option>
                    <option value="app" data-cost="10">Application (10 cr√©dits)</option>
                    <option value="system" data-cost="20">Syst√®me complexe (20 cr√©dits)</option>
                </select>

                <button class="btn" id="generateBtn" onclick="generateCode()">
                    ‚ú® G√©n√©rer (co√ªtera 1 cr√©dits)
                </button>

                <div id="generateLoading" class="loading">
                    <div class="spinner"></div>
                    <p>G√©n√©ration en cours...</p>
                </div>

                <div id="generatedCode" style="display: none; margin-top: 20px;">
                    <h3>Code g√©n√©r√© :</h3>
                    <pre style="background: var(--dark); color: #10b981; padding: 20px; border-radius: 8px; overflow-x: auto;"><code id="codeOutput"></code></pre>

                    <button class="btn" onclick="copyCode()">
                        üìã Copier le code
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB: Config -->
        <div id="tab-config" class="tab-content">
            <div class="section">
                <h2>‚öôÔ∏è Configuration IA Personnelle</h2>

                <div id="configAlert" class="alert"></div>

                <p style="margin-bottom: 20px; color: var(--gray);">
                    Configurez votre propre IA pour g√©n√©rer du code. Les param√®tres sont stock√©s localement (API key encod√©e en Base64).
                </p>

                <label>Provider IA</label>
                <select id="aiProvider" onchange="toggleProviderConfig()">
                    <option value="openai">OpenAI (GPT-4, GPT-3.5)</option>
                    <option value="groq">Groq (Llama 3, Mixtral)</option>
                    <option value="anthropic">Anthropic (Claude)</option>
                    <option value="local">Local (Ollama)</option>
                </select>

                <div id="apiKeyConfig">
                    <label>API Key</label>
                    <input type="password" id="apiKey" placeholder="sk-..." />
                </div>

                <div id="localConfig" style="display: none;">
                    <label>Ollama Endpoint</label>
                    <input type="text" id="ollamaEndpoint" placeholder="http://localhost:11434" value="http://localhost:11434" />
                </div>

                <label>Mod√®le</label>
                <input type="text" id="aiModel" placeholder="gpt-4" value="gpt-4" />

                <label>Temp√©rature (0.0 - 1.0)</label>
                <input type="text" id="temperature" placeholder="0.7" value="0.7" />

                <label>Max Tokens</label>
                <input type="text" id="maxTokens" placeholder="2000" value="2000" />

                <button class="btn" onclick="saveAIConfig()">
                    üíæ Sauvegarder la configuration
                </button>

                <button class="btn btn-small" onclick="testAIConfig()" style="margin-left: 10px;">
                    üß™ Tester la connexion
                </button>
            </div>
        </div>

        <!-- TAB: Stats -->
        <div id="tab-stats" class="tab-content">
            <div class="section">
                <h2>üìä Statistiques Globales</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Contributeurs</div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, var(--success) 0%, #059669 100%);">
                        <div class="stat-value" id="totalRepos">0</div>
                        <div class="stat-label">Repos Contribu√©s</div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);">
                        <div class="stat-value" id="totalLines">0</div>
                        <div class="stat-label">Lignes de Code</div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                        <div class="stat-value" id="totalLanguages">10</div>
                        <div class="stat-label">Langages Support√©s</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">R√©partition par langage</h3>
                <div id="languageStats"></div>
            </div>

            <div class="section">
                <h2>üë§ Vos Statistiques Personnelles</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="myRepos">0</div>
                        <div class="stat-label">Repos Contribu√©s</div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, var(--success) 0%, #059669 100%);">
                        <div class="stat-value" id="myCreditsEarned">0</div>
                        <div class="stat-label">Cr√©dits Gagn√©s</div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);">
                        <div class="stat-value" id="myCreditsSpent">0</div>
                        <div class="stat-label">Cr√©dits D√©pens√©s</div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                        <div class="stat-value" id="myGenerations">0</div>
                        <div class="stat-label">G√©n√©rations Effectu√©es</div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
// ==================== STATE MANAGEMENT ====================
let currentUser = null;
let selectedRepos = new Set();
const COMPLEXITY_COSTS = {
    'snippet': 1,
    'script': 2,
    'component': 5,
    'app': 10,
    'system': 20
};

// ==================== INITIALIZATION ====================
window.onload = function() {
    checkAuth();
    loadStats();
    updateGenerateButtonCost(); // Initialize cost display
};

function checkAuth() {
    const token = localStorage.getItem('github_token_encoded');
    const username = localStorage.getItem('github_username');

    if (token && username) {
        currentUser = { username, token };
        showMainApp();
    } else {
        showLogin();
    }
}

function showLogin() {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
}

function showMainApp() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');

    document.getElementById('usernameDisplay').textContent = currentUser.username;
    loadUserCredits();
    loadUserStats();
}

// ==================== AUTHENTICATION ====================
async function login() {
    const username = document.getElementById('gitUsername').value.trim();
    const token = document.getElementById('gitToken').value.trim();

    if (!username || !token) {
        showAlert('loginAlert', 'Veuillez remplir tous les champs', 'error');
        return;
    }

    console.log('üì° Login attempt:', username);

    // Encoded token (Base64) - This is NOT encryption!
    // In a production app, this token should ONLY be sent to a secure backend.
    const encodedToken = btoa(token); 

    try {
        // Store locally (still insecure, but necessary for a client-side mockup)
        localStorage.setItem('github_username', username);
        localStorage.setItem('github_token_encoded', encodedToken);

        // Simulated backend call
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, token: encodedToken })
        });

        const result = await response.json();

        if (result.success) {
            currentUser = { username, token: encodedToken };
            showAlert('loginAlert', 'Connexion r√©ussie !', 'success');
            setTimeout(() => showMainApp(), 1000);
        } else {
            // Backend should return a failure if the token is invalid
            showAlert('loginAlert', result.message || 'Erreur de connexion (Token invalide ?)', 'error');
        }
    } catch (error) {
        console.error('Login error:', error);
        showAlert('loginAlert', 'Erreur de connexion au serveur (Simul√©)', 'error');
    }
}

function logout() {
    localStorage.removeItem('github_token_encoded');
    localStorage.removeItem('github_username');
    localStorage.removeItem('ai_config');
    currentUser = null;
    selectedRepos.clear();
    showLogin();
}

// ==================== REPOS MANAGEMENT ====================
async function loadRepos() {
    if (!currentUser) return;

    console.log('üì° Loading repos for:', currentUser.username);

    document.getElementById('repoLoading').style.display = 'block';
    document.getElementById('repoList').innerHTML = '';

    try {
        const response = await fetch('/api/repos/list', {
            headers: {
                'X-User-Id': currentUser.username,
                'X-Token': currentUser.token
            }
        });

        const result = await response.json();

        if (result.success) {
            displayRepos(result.repos);
            showAlert('repoAlert', `${result.repos.length} repos trouv√©s`, 'success');
        } else {
            showAlert('repoAlert', result.message || 'Erreur de chargement (Permissions token ?)', 'error');
        }
    } catch (error) {
        console.error('Load repos error:', error);
        showAlert('repoAlert', 'Erreur de connexion au serveur', 'error');
    } finally {
        document.getElementById('repoLoading').style.display = 'none';
    }
}

function displayRepos(repos) {
    const container = document.getElementById('repoList');
    container.innerHTML = '';

    if (repos.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray);">Aucun repo trouv√©</p>';
        return;
    }

    repos.forEach(repo => {
        const item = document.createElement('div');
        item.className = 'repo-item';
        item.innerHTML = `
            <div class="repo-info">
                <div class="repo-name">
                    ${repo.name}
                    <span class="repo-badge ${getBadgeClass(repo.license)}">${repo.license || 'No License'}</span>
                </div>
                <div class="repo-meta">
                    ${repo.language || 'Unknown'} ‚Ä¢ ${formatNumber(repo.size || 0)} KB ‚Ä¢ ‚≠ê ${repo.stars || 0}
                </div>
            </div>
            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" 
                       value="${repo.id}" 
                       onchange="toggleRepoSelection('${repo.id}')"
                       ${repo.contributed ? 'checked disabled' : ''}>
                ${repo.contributed ? 'D√©j√† contribu√©' : 'S√©lectionner'}
            </label>
        `;
        container.appendChild(item);
    });
}

function getBadgeClass(license) {
    if (!license) return 'badge-danger';
    const compatible = ['MIT', 'Apache-2.0', 'BSD', 'CC0', 'Unlicense', 'ISC']; // Added ISC
    return compatible.includes(license) ? 'badge-success' : 'badge-warning';
}

function toggleRepoSelection(repoId) {
    if (selectedRepos.has(repoId)) {
        selectedRepos.delete(repoId);
    } else {
        selectedRepos.add(repoId);
    }
    console.log('Selected repos:', Array.from(selectedRepos));
}

async function contributeSelected() {
    if (!currentUser) return;

    if (selectedRepos.size === 0) {
        showAlert('repoAlert', 'Veuillez s√©lectionner au moins un repo', 'error');
        return;
    }

    console.log('üì° Contributing repos:', Array.from(selectedRepos));

    showAlert('repoAlert', 'Traitement en cours... (peut prendre plusieurs minutes)', 'info');

    try {
        const response = await fetch('/api/repos/contribute', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-User-Id': currentUser.username
            },
            body: JSON.stringify({
                repoIds: Array.from(selectedRepos)
            })
        });

        const result = await response.json();

        if (result.success) {
            showAlert('repoAlert', `‚úÖ ${result.processed} repos trait√©s ! +${result.creditsEarned} cr√©dits gagn√©s`, 'success');
            selectedRepos.clear();
            loadUserCredits();
            loadRepos();
        } else {
            showAlert('repoAlert', result.message || 'Erreur de contribution', 'error');
        }
    } catch (error) {
        console.error('Contribute error:', error);
        showAlert('repoAlert', 'Erreur de connexion au serveur', 'error');
    }
}

// ==================== CODE GENERATION ====================

function updateGenerateButtonCost() {
    const select = document.getElementById('complexity');
    const selectedOption = select.options[select.selectedIndex];
    const cost = selectedOption.getAttribute('data-cost');
    document.getElementById('generateBtn').textContent = `‚ú® G√©n√©rer (co√ªtera ${cost} cr√©dits)`;
}

async function generateCode() {
    if (!currentUser) return;

    const prompt = document.getElementById('prompt').value.trim();
    const language = document.getElementById('language').value;
    const complexity = document.getElementById('complexity').value;

    if (!prompt) {
        showAlert('generateAlert', 'Veuillez d√©crire ce que vous voulez cr√©er', 'error');
        return;
    }

    // Check AI config
    const aiConfig = JSON.parse(localStorage.getItem('ai_config') || '{}');
    if (!aiConfig.provider) {
        showAlert('generateAlert', 'Veuillez configurer votre IA dans l\'onglet Configuration', 'error');
        switchTab(document.querySelector('.tabs button[onclick*="config"]'), 'config'); // Fix for switchTab call
        return;
    }

    // Cost check (simulate server-side logic)
    const currentCredits = parseInt(document.getElementById('creditsDisplay').textContent) || 0;
    const requiredCost = COMPLEXITY_COSTS[complexity] || 0;
    if (currentCredits < requiredCost) {
        showAlert('generateAlert', `Cr√©dits insuffisants. Il vous faut ${requiredCost} cr√©dits.`, 'error');
        return;
    }

    console.log('üì° Generating code:', { prompt, language, complexity });

    document.getElementById('generateLoading').style.display = 'block';
    document.getElementById('generatedCode').style.display = 'none';

    try {
        const response = await fetch('/api/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-User-Id': currentUser.username
            },
            body: JSON.stringify({
                prompt,
                language,
                complexity,
                aiConfig
            })
        });

        const result = await response.json();

        if (result.success) {
            document.getElementById('codeOutput').textContent = result.code;
            document.getElementById('generatedCode').style.display = 'block';
            showAlert('generateAlert', `‚úÖ Code g√©n√©r√© ! -${result.creditsSpent} cr√©dits`, 'success');
            loadUserCredits();
        } else {
            showAlert('generateAlert', result.message || 'Erreur de g√©n√©ration. V√©rifiez votre config IA.', 'error');
        }
    } catch (error) {
        console.error('Generate error:', error);
        showAlert('generateAlert', 'Erreur de connexion au serveur', 'error');
    } finally {
        document.getElementById('generateLoading').style.display = 'none';
    }
}

function copyCode() {
    const code = document.getElementById('codeOutput').textContent;
    // Use the reliable method for copying (requires user interaction)
    navigator.clipboard.writeText(code).then(() => {
        showAlert('generateAlert', 'üìã Code copi√© dans le presse-papier', 'success');
    }).catch(err => {
        console.error('Could not copy text: ', err);
        showAlert('generateAlert', '‚ùå Erreur de copie (v√©rifiez les permissions)', 'error');
    });
}

// ==================== AI CONFIGURATION ====================
function toggleProviderConfig() {
    const provider = document.getElementById('aiProvider').value;

    if (provider === 'local') {
        document.getElementById('apiKeyConfig').style.display = 'none';
        document.getElementById('localConfig').style.display = 'block';
    } else {
        document.getElementById('apiKeyConfig').style.display = 'block';
        document.getElementById('localConfig').style.display = 'none';
    }
}

function saveAIConfig() {
    const provider = document.getElementById('aiProvider').value;
    const apiKey = document.getElementById('apiKey').value.trim();
    const model = document.getElementById('aiModel').value.trim();
    const temperatureInput = document.getElementById('temperature').value;
    const maxTokensInput = document.getElementById('maxTokens').value;
    const ollamaEndpoint = document.getElementById('ollamaEndpoint').value.trim();

    const temperature = parseFloat(temperatureInput);
    const maxTokens = parseInt(maxTokensInput);

    if (provider !== 'local' && !apiKey) {
        showAlert('configAlert', 'Veuillez entrer votre API key', 'error');
        return;
    }
    if (isNaN(temperature) || temperature < 0 || temperature > 1) {
        showAlert('configAlert', 'Temp√©rature invalide (doit √™tre entre 0.0 et 1.0)', 'error');
        return;
    }
    if (isNaN(maxTokens) || maxTokens < 1) {
        showAlert('configAlert', 'Max Tokens invalide (doit √™tre un nombre > 0)', 'error');
        return;
    }

    const config = {
        provider,
        apiKey: provider === 'local' ? null : btoa(apiKey), // Encoded, not encrypted!
        model,
        temperature,
        maxTokens,
        ollamaEndpoint: provider === 'local' ? ollamaEndpoint : null
    };

    localStorage.setItem('ai_config', JSON.stringify(config));
    showAlert('configAlert', '‚úÖ Configuration sauvegard√©e !', 'success');
    console.log('AI config saved:', { ...config, apiKey: config.apiKey ? '***' : null });
}

async function testAIConfig() {
    const aiConfig = JSON.parse(localStorage.getItem('ai_config') || '{}');

    if (!aiConfig.provider) {
        showAlert('configAlert', 'Veuillez d\'abord sauvegarder votre configuration', 'error');
        return;
    }

    console.log('üß™ Testing AI config...');
    showAlert('configAlert', 'Test de connexion en cours...', 'info');

    try {
        const response = await fetch('/api/ai/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ aiConfig })
        });

        const result = await response.json();

        if (result.success) {
            showAlert('configAlert', '‚úÖ Connexion r√©ussie ! IA fonctionnelle.', 'success');
        } else {
            showAlert('configAlert', `‚ùå Erreur de test: ${result.message}`, 'error');
        }
    } catch (error) {
        console.error('Test AI error:', error);
        showAlert('configAlert', 'Erreur de connexion au serveur (V√©rifiez l\'endpoint/la cl√©)', 'error');
    }
}

// ==================== CREDITS & STATS ====================
async function loadUserCredits() {
    if (!currentUser) return;
    try {
        const response = await fetch('/api/user/credits', {
            headers: { 'X-User-Id': currentUser.username }
        });

        const result = await response.json();

        if (result.success) {
            document.getElementById('creditsDisplay').textContent = result.credits.toLocaleString();
        }
    } catch (error) {
        console.error('Load credits error:', error);
    }
}

async function loadUserStats() {
    if (!currentUser) return;
    try {
        const response = await fetch('/api/user/stats', {
            headers: { 'X-User-Id': currentUser.username }
        });

        const result = await response.json();

        if (result.success) {
            document.getElementById('myRepos').textContent = result.repos.toLocaleString();
            document.getElementById('myCreditsEarned').textContent = result.creditsEarned.toLocaleString();
            document.getElementById('myCreditsSpent').textContent = result.creditsSpent.toLocaleString();
            document.getElementById('myGenerations').textContent = result.generations.toLocaleString();
        }
    } catch (error) {
        console.error('Load user stats error:', error);
    }
}

async function loadStats() {
    try {
        const response = await fetch('/api/stats/global');
        const result = await response.json();

        if (result.success) {
            document.getElementById('totalUsers').textContent = result.users.toLocaleString();
            document.getElementById('totalRepos').textContent = result.repos.toLocaleString();
            document.getElementById('totalLines').textContent = formatNumber(result.lines);

            // Language stats
            const langContainer = document.getElementById('languageStats');
            langContainer.innerHTML = '';

            const languages = result.languages || {};
            const totalCount = Object.values(languages).reduce((sum, count) => sum + count, 0);

            Object.entries(languages).forEach(([lang, count]) => {
                const percentage = totalCount > 0 ? (count / totalCount) * 100 : 0;

                const bar = document.createElement('div');
                bar.style.cssText = 'margin-bottom: 10px;';
                bar.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>${lang}</span>
                        <span>${count.toLocaleString()} fichiers (${percentage.toFixed(1)}%)</span>
                    </div>
                    <div style="background: var(--light); height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: var(--primary); height: 100%; width: ${percentage}%;"></div>
                    </div>
                `;
                langContainer.appendChild(bar);
            });
        }
    } catch (error) {
        console.error('Load stats error:', error);
    }
}

// ==================== UTILITIES ====================
// FIX: The function now takes the button element to correctly apply the active class.
function switchTab(buttonElement, tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });

    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(`tab-${tabName}`).classList.add('active');
    buttonElement.classList.add('active'); // Use the passed element

    // Load data if needed
    if (tabName === 'stats') {
        loadStats();
        loadUserStats();
    }
}

function showAlert(elementId, message, type) {
    const alert = document.getElementById(elementId);
    alert.className = `alert alert-${type}`; // Simplified class selection
    alert.textContent = message;
    alert.style.display = 'block';

    setTimeout(() => {
        alert.style.display = 'none';
    }, 5000);
}

function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toLocaleString();
}

// Load AI config on page load
window.addEventListener('load', () => {
    const savedConfig = JSON.parse(localStorage.getItem('ai_config') || '{}');

    if (savedConfig.provider) {
        document.getElementById('aiProvider').value = savedConfig.provider;
        document.getElementById('aiModel').value = savedConfig.model || '';
        document.getElementById('temperature').value = savedConfig.temperature || 0.7;
        document.getElementById('maxTokens').value = savedConfig.maxTokens || 2000;

        if (savedConfig.provider === 'local') {
            document.getElementById('ollamaEndpoint').value = savedConfig.ollamaEndpoint || 'http://localhost:11434';
            toggleProviderConfig();
        } else if (savedConfig.apiKey) {
            // Decode Base64 for display
            try {
                document.getElementById('apiKey').value = atob(savedConfig.apiKey);
            } catch (e) {
                console.error("Erreur de d√©codage de la cl√© API:", e);
                document.getElementById('apiKey').value = "Cl√© corrompue";
            }
        }
    }
    toggleProviderConfig(); // Ensure correct initial display for API key/Ollama config
});
</script>
</body>
</html>